#!/bin/sh

SPRITEDESC_CONV=$(which spritedesc-conv)

if [ -z "$SPRITEDESC_CONV" ]
then
    SPRITEDESC_CONV="$(pwd)/$(echo $0 | sed 's:[^/]\+$:spritedesc-conv:')"
fi

# Generate the informations about an xcf file in the format expected by
# spritedesc-conv.
# param 1 The name of the xcf file to read
#
generate_xcf_info() {
    XCF_FILE="$1"

    echo "$XCF_FILE"

    xcfinfo "$XCF_FILE" \
        | head -n 1 \
        | sed 's:^[^,]\+, \([0-9]\+\)x\([0-9]\+\)[^,]\+, \([0-9]\+\).\+$:\1 \2 \3:'

    xcfinfo "$XCF_FILE" \
        | tail -n +2 \
        | sed 's:^[-+] \([0-9]\+\)x\([0-9]\+\)\([-+][0-9]\+\)\([-+][0-9]\+\)\( [^ ]\+\)\{2\} \(.\+\)$:\1 \2 \3 \4 \6:'
} # generate_xcf_info()

# Find all the xcf files used in a given text file.
# param 1: The file in which the names are searched.
#
get_xcf_names() {

    grep '\.xcf\(.bz2\)\?"' "$1" \
        | sed 's:[^"]*"\([^"]\+\.xcf\(\.bz2\)\?\)"[^"]*:\1 :g'
} # get_xcf_names()

DESC_FILE="$1"
shift
INITIAL_DIR="$(pwd)"

if echo "$DESC_FILE" | grep '/' > /dev/null
then
    cd $(echo "$DESC_FILE" | sed 's:[^/]\+$::g')
    DESC_FILE=$(basename "$DESC_FILE")
fi

(
    get_xcf_names "$DESC_FILE" \
        | while read XCF_FILE
    do
        generate_xcf_info "$XCF_FILE"
    done
) | "$SPRITEDESC_CONV" $@ "$DESC_FILE"
